// Prisma Schema for MyLittlePrice Elysia Server
// Generated from existing PostgreSQL migrations

generator client {
  provider = "prisma-client-js"
}

generator prismabox {
  provider = "prismabox"
  output   = "../src/generated/prismabox"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER AUTHENTICATION
// ============================================================================

model User {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String         @unique @db.VarChar(255)
  passwordHash  String         @map("password_hash") @db.VarChar(255)
  fullName      String?        @map("full_name") @db.VarChar(255)

  // OAuth fields
  googleId      String?        @unique @map("google_id") @db.VarChar(255)
  avatarUrl     String?        @map("avatar_url") @db.Text

  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamp
  lastLoginAt   DateTime?      @map("last_login_at") @db.Timestamp

  // Relations
  refreshTokens RefreshToken[]
  chatSessions  ChatSession[]
  searchHistory SearchHistory[]

  @@index([email], name: "idx_users_email")
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(255)
  expiresAt DateTime  @map("expires_at") @db.Timestamp
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp
  revokedAt DateTime? @map("revoked_at") @db.Timestamp

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_refresh_tokens_user_id")
  @@index([tokenHash], name: "idx_refresh_tokens_token_hash")
  @@map("refresh_tokens")
}

// ============================================================================
// CHAT SESSIONS
// ============================================================================

model ChatSession {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId   String   @unique @map("session_id") @db.VarChar(255)
  userId      String?  @map("user_id") @db.Uuid

  // Locale settings
  countryCode  String  @map("country_code") @db.VarChar(2)
  languageCode String  @map("language_code") @db.VarChar(5)
  currency     String  @db.VarChar(3)

  // Counters
  messageCount Int     @default(0) @map("message_count")

  // State management (JSONB columns)
  searchState          Json?  @map("search_state") @db.JsonB
  cycleState           Json?  @map("cycle_state") @db.JsonB
  conversationContext  Json?  @map("conversation_context") @db.JsonB

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp
  expiresAt DateTime @map("expires_at") @db.Timestamp

  // Relations
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages      Message[]
  searchHistory SearchHistory[]
  searchQueries SearchQuery[]

  @@index([sessionId], name: "idx_chat_sessions_session_id")
  @@index([expiresAt], name: "idx_chat_sessions_expires_at")
  @@index([userId], name: "idx_chat_sessions_user_id")
  @@map("chat_sessions")
}

// ============================================================================
// MESSAGES
// ============================================================================

model Message {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId    String   @map("session_id") @db.Uuid
  role         String   @db.VarChar(20)
  content      String   @db.Text
  responseType String?  @map("response_type") @db.VarChar(20)
  quickReplies Json?    @map("quick_replies") @db.JsonB
  metadata     Json?    @db.JsonB
  products     Json?    @db.JsonB
  searchInfo   Json?    @map("search_info") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], name: "idx_messages_session_id")
  @@index([createdAt], name: "idx_messages_created_at")
  @@map("messages")
}

// ============================================================================
// SEARCH & ANALYTICS
// ============================================================================

model SearchHistory {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?   @map("user_id") @db.Uuid
  sessionId       String?   @map("session_id") @db.Uuid

  // Search details
  searchQuery     String    @map("search_query") @db.Text
  optimizedQuery  String?   @map("optimized_query") @db.Text
  searchType      String    @map("search_type") @db.VarChar(20)
  category        String?   @db.VarChar(100)

  // Search parameters
  countryCode     String    @map("country_code") @db.VarChar(2)
  languageCode    String    @map("language_code") @db.VarChar(5)
  currency        String    @db.VarChar(3)

  // Results metadata
  resultCount     Int       @default(0) @map("result_count")
  productsFound   Json?     @map("products_found") @db.JsonB

  // Interaction tracking
  clickedProductId String?  @map("clicked_product_id") @db.Text

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp
  expiresAt       DateTime? @map("expires_at") @db.Timestamp

  // Relations
  user    User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  session ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_search_history_user_id")
  @@index([sessionId], name: "idx_search_history_session_id")
  @@index([createdAt], name: "idx_search_history_created_at")
  @@index([expiresAt], name: "idx_search_history_expires_at")
  @@map("search_history")
}

model SearchQuery {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId      String?     @map("session_id") @db.Uuid
  originalQuery  String      @map("original_query") @db.Text
  optimizedQuery String      @map("optimized_query") @db.Text
  searchType     String      @map("search_type") @db.VarChar(20)
  countryCode    String      @map("country_code") @db.VarChar(2)
  resultCount    Int         @default(0) @map("result_count")
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamp

  // Relations
  session ChatSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId], name: "idx_search_queries_session_id")
  @@index([optimizedQuery], name: "idx_search_queries_optimized")
  @@map("search_queries")
}

// ============================================================================
// PRODUCTS CACHE
// ============================================================================

model ProductsCache {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  pageToken       String   @unique @map("page_token") @db.Text
  productName     String   @map("product_name") @db.Text
  countryCode     String   @map("country_code") @db.VarChar(2)
  priceInfo       Json     @map("price_info") @db.JsonB
  merchantInfo    Json?    @map("merchant_info") @db.JsonB
  productDetails  Json?    @map("product_details") @db.JsonB
  imageUrl        String?  @map("image_url") @db.Text
  link            String?  @db.Text
  rating          Decimal? @db.Decimal(3, 2)
  fetchCount      Int      @default(0) @map("fetch_count")
  lastFetchedAt   DateTime @default(now()) @map("last_fetched_at") @db.Timestamp
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp

  @@index([fetchCount], name: "idx_products_cache_popularity")
  @@map("products_cache")
}

// ============================================================================
// API USAGE TRACKING
// ============================================================================

model ApiUsage {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  apiName        String   @map("api_name") @db.VarChar(50)
  keyIndex       Int      @map("key_index")
  requestType    String?  @map("request_type") @db.VarChar(50)
  responseTimeMs Int?     @map("response_time_ms")
  success        Boolean  @default(true)
  errorMessage   String?  @map("error_message") @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp

  @@index([createdAt], name: "idx_api_usage_created_at")
  @@map("api_usage")
}
